<!-- board/item/detail.html -->
<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/fragments/base}">

<head>
    <title th:with="title='Item 상세'">Item 상세</title>
</head>

<body class="board board-item">
<div layout:fragment="content">

    <main class="board-container">

        <!-- 상세 카드 -->
        <div class="board-detail-card">
            <div class="card">
                <h4 class="board-title">상세페이지</h4>
                <img src="https://placehold.co/300">
                <h4 th:text="${data.title}"></h4>
                <p th:text="${data.price + '원'}"></p>

                <!-- 조회수 / 추천수 메타 정보 -->
                <div class="board-meta">
                    조회
                    <span th:text="${data.viewCount}">0</span>
                    · 추천
                    <span id="recommendCount" th:text="${data.recommendCount}">0</span>
                </div>
            </div>
        </div>

        <!-- 수정/삭제 버튼 -->
        <div style="margin-top:10px;"
             th:if="${isAdmin or (loginUserId != null and loginUserId == data.writer.id)}">

            <!-- 작성자 본인에게만 수정버튼 노출됨 -->
            <a th:href="@{|/item/edit/${data.id}|}"
               th:if="${loginUserId != null and loginUserId == data.writer.id}"
               class="btn-edit" style="margin-right:8px;">수정</a>

            <form th:action="@{|/item/delete/${data.id}|}"
                  method="post"
                  style="display:inline;"
                  onsubmit="return confirm('정말 삭제하시겠습니까?');">
                <!-- HiddenHttpMethodFilter 를 이용해 DELETE 요청으로 처리 -->
                <input type="hidden" name="_method" value="delete">
                <button type="submit" class="btn-delete">삭제</button>
            </form>
        </div>

        <!-- 추천 버튼 -->
        <section class="recommend-section" style="margin-top:12px;">
            <div th:if="${loginUserId != null}">
                <button id="recommendBtn"
                        th:data-post-id="${data.id}"
                        th:text="${isRecommended} ? '추천 취소' : '추천'">
                    추천
                </button>
            </div>
            <div th:unless="${loginUserId != null}">
                <p>추천 기능은 <a href="/login">로그인</a> 후 이용할 수 있습니다.</p>
            </div>
        </section>

        <!-- 주문 UI -->
        <form id="orderForm" action="/order" method="post" style="margin-top:12px;">
            <input type="hidden" name="itemId" th:value="${data.id}">
            <input name="count" type="number" min="1" placeholder="수량" required>
            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
            <button type="button" id="openOrderModal">주문하기</button>
        </form>

        <!-- 주문 모달 -->
        <div id="orderModal" class="modal" aria-hidden="true" style="display:none;">
            <div class="modal-backdrop"></div>
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="orderModalTitle">
                <h3 id="orderModalTitle" style="margin-top:0;">주문하시겠습니까?</h3>
                <p>선택하신 상품을 주문합니다.</p>
                <div class="modal-actions">
                    <button type="button" id="orderConfirm">예</button>
                    <button type="button" id="orderCancel">아니오</button>
                </div>
            </div>
        </div>

        <!-- 댓글 작성 Form (공통) -->
        <div th:replace="~{layout/fragments/commentForm :: form(${data.id}, ${loginUserId})}"></div>

        <!-- 댓글 트리 (공통) -->
        <div th:replace="~{layout/fragments/commentTree :: list(${comments}, ${loginUserId}, ${data.id}, ${isAdmin})}"></div>

        <!-- 스타일 -->
        <style>
            .modal { position: fixed; inset: 0; z-index: 1000; }
            .modal-backdrop { position:absolute; inset:0; background:rgba(0,0,0,.45); }
            .modal-content {
              position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
              background:#fff; padding:20px; border-radius:12px; min-width:280px; max-width:90%;
              box-shadow: 0 10px 30px rgba(0,0,0,.2);
            }
            .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; }
            .board-meta { margin-top: 8px; font-size: 0.9rem; color: #555; }
            .recommend-section { margin-top: 8px; }
        </style>

        <script>
            (function () {

                // 추천 버튼  // [MOD]
                const recommendBtn = document.getElementById('recommendBtn');
                if (recommendBtn) {
                    recommendBtn.addEventListener('click', async function () {
                        const postId = this.dataset.postId;

                        try {
                            const res = await fetch(`/item/${postId}/recommend`, {
                                method: 'POST',
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });

                            if (res.status === 401) {
                                alert('로그인이 필요합니다.');
                                return location.href = '/login';
                            }

                            if (!res.ok) {
                                alert('요청 처리 중 오류가 발생했습니다.');
                                return;
                            }

                            const body = await res.json();

                            // 버튼 텍스트 토글
                            this.textContent = body.recommended ? '추천 취소' : '추천';

                            // 추천 수 갱신
                            const countEl = document.getElementById('recommendCount');
                            if (countEl && typeof body.recommendCount === 'number') {
                                countEl.textContent = body.recommendCount;
                            }

                        } catch (e) {
                            console.error(e);
                            alert('네트워크 오류가 발생했습니다.');
                        }
                    });
                }

            })();
        </script>

    </main>
</div>
</body>
</html>
