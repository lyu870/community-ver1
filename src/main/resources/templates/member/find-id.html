<!-- member/find-id.html -->
<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/fragments/base}">

<head>
    <title th:with="title='ID 찾기'">ID 찾기</title>
</head>
<body>
<div layout:fragment="content">
    <main class="board-container">

        <section class="auth-card-wrap">
            <div class="auth-tabs">
                <!-- 아이디 찾기 탭 (활성) -->
                <a href="/find-id"
                   class="auth-tab auth-tab-active">
                    아이디 찾기
                </a>
                <!-- 비밀번호 찾기 탭 -->
                <a href="/find-password"
                   class="auth-tab">
                    비밀번호 찾기
                </a>
            </div>

            <div class="auth-card-body">

                <!-- 1단계 : 이메일 + 코드 전송 + 코드 입력 -->
                <section id="findIdFormSection">
                    <p class="text-sm text-center" style="color:#555; margin-bottom:24px;">
                        가입 시 등록한 이메일로 아이디를 확인할 수 있습니다.
                    </p>

                    <form id="findIdForm">
                        <!-- 이메일 + 코드 전송 버튼 -->
                        <label class="auth-label">
                            이메일
                        </label>
                        <div class="flex-row gap-8">
                            <input type="email"
                                   name="email"
                                   placeholder="가입 시 사용한 이메일"
                                   required
                                   class="auth-input"
                                   style="flex:1;">
                            <button type="button"
                                    id="sendIdCodeBtn"
                                    class="auth-btn-inline-primary">
                                인증코드 전송
                            </button>
                        </div>

                        <!-- 이메일 관련 메시지 (이메일 입력칸 바로 아래) -->
                        <div id="findIdMessage"
                             class="msg text-sm"
                             style="display:none;"></div>

                        <!-- 인증코드 입력 -->
                        <div class="mt-14">
                            <label class="auth-label">
                                이메일로 받은 인증코드
                            </label>
                            <input type="text"
                                   name="code"
                                   placeholder="인증코드 6자리"
                                   required
                                   class="auth-input">
                        </div>

                        <div class="mt-18">
                            <button type="submit"
                                    class="auth-btn-primary">
                                아이디 찾기
                            </button>
                        </div>
                    </form>

                    <!-- 가입된 이메일이 없을 때 보여줄 버튼들 -->
                    <div id="findIdErrorActions"
                         class="flex-row flex-center gap-10 mt-12"
                         style="display:none;">
                        <a href="/register"
                           style="flex:1; max-width:160px; text-align:center; padding:8px 0;
                                  border:1px solid #2c7efb; background:#fff; color:#2c7efb;
                                  text-decoration:none; font-size:13px;">
                            회원가입
                        </a>
                        <a href="/"
                           style="flex:1; max-width:160px; text-align:center; padding:8px 0;
                                  border:1px solid #d0d3d9; background:#fff; color:#555;
                                  text-decoration:none; font-size:13px;">
                            홈으로 돌아가기
                        </a>
                    </div>
                </section>

                <!-- 2단계 : 아이디찾기 완료 화면 -->
                <section id="findIdResultSection" style="display:none; text-align:center;">
                    <p style="margin-bottom:18px; color:#333;">
                        해당 이메일로 가입된 아이디는 다음과 같습니다.
                    </p>

                    <div style="margin-bottom:24px;">
                        <span id="foundUsername"
                              style="display:inline-block; padding:10px 18px; border:1px solid #d0d3d9;
                                     background:#f5f6f7; font-size:18px; font-weight:bold; letter-spacing:1px;">
                        </span>
                    </div>

                    <div class="flex-row gap-10" style="justify-content:center;">
                        <a href="/login"
                           style="flex:1; max-width:160px; text-align:center; padding:10px 0;
                                  border:1px solid #2c7efb; background:#2c7efb; color:#fff;
                                  text-decoration:none; font-size:14px;">
                            로그인
                        </a>
                        <a href="/find-password"
                           style="flex:1; max-width:160px; text-align:center; padding:10px 0;
                                  border:1px solid #d0d3d9; background:#fff; color:#2c7efb;
                                  text-decoration:none; font-size:14px;">
                            비밀번호 찾기
                        </a>
                    </div>
                </section>

            </div>
        </section>

        <script>
            (function () {

                const findIdFormSection = document.getElementById('findIdFormSection');
                const findIdResultSection = document.getElementById('findIdResultSection');

                const findIdForm = document.getElementById('findIdForm');
                const sendIdCodeBtn = document.getElementById('sendIdCodeBtn');

                const findIdMessage = document.getElementById('findIdMessage');
                const findIdErrorActions = document.getElementById('findIdErrorActions');
                const foundUsernameEl = document.getElementById('foundUsername');

                function showForm() {
                    if (findIdFormSection) findIdFormSection.style.display = 'block';
                    if (findIdResultSection) findIdResultSection.style.display = 'none';
                }

                function showResult() {
                    if (findIdFormSection) findIdFormSection.style.display = 'none';
                    if (findIdResultSection) findIdResultSection.style.display = 'block';
                }

                function setFindIdMessage(text, isError, showActions) {
                    if (!findIdMessage) return;
                    findIdMessage.textContent = text || '';
                    findIdMessage.className = 'msg text-sm ' + (isError ? 'err' : 'ok');
                    findIdMessage.style.display = text ? 'block' : 'none';

                    if (findIdErrorActions) {
                        findIdErrorActions.style.display = showActions ? 'flex' : 'none';
                    }
                }

                // 인증코드 전송 버튼
                if (sendIdCodeBtn && findIdForm) {
                    sendIdCodeBtn.addEventListener('click', async function () {
                        setFindIdMessage('전송 중... 잠시만 기다려주세요.', false, false);
                        sendIdCodeBtn.disabled = true;

                        const formData = new FormData(findIdForm);
                        const email = formData.get('email');

                        if (!email) {
                            setFindIdMessage('이메일을 입력해주세요.', true, false);
                            sendIdCodeBtn.disabled = false;
                            return;
                        }

                        try {
                            const res = await fetch('/member/find-id/email-code', {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                },
                                body: new URLSearchParams({
                                    email: email
                                }).toString()
                            });

                            const body = await res.json();
                            sendIdCodeBtn.disabled = false;

                            if (body.success) {
                                setFindIdMessage(body.message || '인증번호를 전송했습니다.', false, false);
                            } else {
                                setFindIdMessage(body.error || '인증코드 전송에 실패했습니다.', true, true);
                            }
                        } catch (err) {
                            sendIdCodeBtn.disabled = false;
                            setFindIdMessage('오류가 발생했습니다. 잠시 후 다시 시도해주세요.', true, true);
                        }
                    });
                }

                // 아이디 찾기 폼 제출: 코드 검증 + 아이디 표시
                if (findIdForm) {
                    findIdForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        setFindIdMessage('', false, false);

                        const formData = new FormData(findIdForm);
                        const email = formData.get('email');
                        const code = formData.get('code');

                        try {
                            const res = await fetch('/member/find-id/confirm', {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                },
                                body: new URLSearchParams({
                                    email: email,
                                    code: code
                                }).toString()
                            });

                            const body = await res.json();

                            if (body.success) {
                                if (foundUsernameEl) {
                                    foundUsernameEl.textContent = body.username || '';
                                }
                                showResult();
                            } else {
                                setFindIdMessage(body.error || '아이디를 찾을 수 없습니다.', true, true);
                            }
                        } catch (err) {
                            setFindIdMessage('오류가 발생했습니다. 잠시 후 다시 시도해주세요.', true, true);
                        }
                    });
                }

                // 초기 상태는 입력폼 보여주기
                showForm();

            })();
        </script>

    </main>
</div>
</body>
</html>
