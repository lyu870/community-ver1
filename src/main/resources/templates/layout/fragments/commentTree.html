<!-- /templates/layout/fragments/commentTree.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<body>

<!-- 댓글 트리 목록 -->
<div th:fragment="list(comments, loginUserId, postId, isAdmin)">

    <div class="comment-tree"
         th:attr="data-post-id=${postId}, data-login-user-id=${loginUserId}, data-is-admin=${isAdmin}">
        <div th:each="c : ${comments}">
            <div th:replace="~{layout/fragments/commentTree :: node(${c}, 0, ${loginUserId}, ${postId}, ${isAdmin})}"></div>
        </div>
    </div>

</div>


<!-- 개별 댓글 노드 -->
<div th:fragment="node(comment, depth, loginUserId, postId, isAdmin)">

    <!-- 들여쓰기용 wrapper -->
    <div class="comment-node"
         th:style="'margin-left:' + (${depth} * 20) + 'px'"
         th:attr="data-comment-id=${comment.id}, data-writer-id=${comment.writer.id}, data-writer-name=${comment.writer.displayName}, data-created-at=${#temporals.format(comment.createdAt, 'yyyy-MM-dd''T''HH:mm:ss')}">

        <div class="comment-item">

            <div class="comment-body">

                <!-- 삭제된 댓글 처리 -->
                <div th:if="${comment.content == '삭제된 댓글입니다.'}" class="comment-deleted">
                    삭제된 댓글입니다.
                </div>

                <!-- 일반 댓글 -->
                <div th:unless="${comment.content == '삭제된 댓글입니다.'}">

                    <!-- 작성자 -->
                    <div class="comment-writer">
                        <strong th:text="${comment.writer.displayName}">작성자</strong>

                        <span class="comment-time js-timeago"
                              th:attr="data-time=${#temporals.format(comment.createdAt, 'yyyy-MM-dd''T''HH:mm:ss')}">
                            방금 전
                        </span>

                        <span class="comment-edited"
                              th:if="${comment.updatedAt != null and comment.createdAt != null and comment.updatedAt.isAfter(comment.createdAt)}">
                            (수정됨)
                        </span>
                    </div>

                    <!-- 댓글 내용 -->
                    <p class="comment-content"
                       th:text="${comment.content}"
                       th:attr="data-comment-id=${comment.id}">
                    </p>

                    <!-- 수정 폼 -->
                    <form class="comment-edit-form"
                          action="/comment/edit"
                          method="post"
                          th:attr="data-comment-id=${comment.id}"
                          style="display:none;"
                          th:if="${loginUserId == comment.writer.id}">
                        <input type="hidden" name="id" th:value="${comment.id}">
                        <input type="hidden" name="postId" th:value="${postId}">
                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <textarea name="content" rows="2" th:text="${comment.content}"></textarea>

                        <!-- 수정 버튼/텍스트박스 스타일을 답글과 동일하게 -->
                        <div class="comment-reply-actions">
                            <button type="button" class="btn btn-ghost btn-sm comment-edit-cancel">취소</button>
                            <button type="submit" class="btn btn-primary btn-sm">저장</button>
                        </div>
                    </form>

                    <!-- 버튼 영역 -->
                    <div class="comment-actions">
                        <button type="button"
                                class="comment-reply-btn"
                                th:attr="data-comment-id=${comment.id}">
                            답글
                        </button>

                        <!-- 수정 버튼: 작성자만 -->
                        <span th:if="${loginUserId == comment.writer.id}">
                            <button type="button"
                                    class="comment-edit-btn"
                                    th:attr="data-comment-id=${comment.id}">
                                수정
                            </button>
                        </span>

                        <!-- 삭제 버튼: 작성자 + 관리자 -->
                        <span th:if="${isAdmin or loginUserId == comment.writer.id}">
                            <form action="/comment/delete"
                                  method="post"
                                  class="comment-delete-form"
                                  style="display:inline;">
                                <input type="hidden" name="id" th:value="${comment.id}">
                                <input type="hidden" name="postId" th:value="${postId}">
                                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button type="button" class="comment-delete-btn">삭제</button>
                            </form>
                        </span>
                    </div>

                    <!-- 답글 입력 폼 -->
                    <form class="comment-reply-form"
                          action="/comment"
                          method="post"
                          th:attr="data-parent-id=${comment.id}"
                          style="display:none;"
                          data-require-login="comment">
                        <input type="hidden" name="postId" th:value="${postId}">
                        <input type="hidden" name="parentId" th:value="${comment.id}">
                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                        <div class="comment-mention-wrap">
                            <span class="comment-mention-pill" hidden>@멘션</span>
                            <textarea name="content" rows="2" placeholder="답글을 입력하세요" required></textarea>
                        </div>

                        <!-- 답글 등록/취소 버튼 영역 -->
                        <div class="comment-reply-actions">
                            <button type="button" class="btn btn-ghost btn-sm comment-reply-cancel">취소</button>
                            <button type="submit" class="btn btn-primary btn-sm">등록</button>
                        </div>
                    </form>

                </div>

                <!-- 답글 n개 보기, 숨기기: replyCount 사용 -->
                <div th:if="${comment.replyCount > 0}">
                    <button type="button"
                            class="comment-replies-toggle"
                            th:attr="data-comment-id=${comment.id}, data-reply-count=${comment.replyCount}, data-depth=${depth + 1}">
                        답글 <span th:text="${comment.replyCount}">0</span>개
                    </button>

                    <div class="comment-children"
                         th:attr="data-parent-id=${comment.id}">
                    </div>
                </div>

            </div>

        </div>

    </div>

</div>

</body>
</html>
