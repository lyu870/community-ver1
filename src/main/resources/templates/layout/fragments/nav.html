<!-- layout/fragments/nav.html -->
<th:block th:fragment="navbar">

    <div class="navbar"
         xmlns:th="http://www.thymeleaf.org"
         xmlns:sec="https://www.thymeleaf.org/extras/spring-security">

        <!-- ì¢Œì¸¡ : ë¡œê³  -->
        <div class="navbar-left">
            <a href="/" class="logo">Community</a>
        </div>

        <!-- ì¤‘ì•™ ë©”ë‰´ -->
        <div class="navbar-center">
            <a href="/notice/list">ê³µì§€ì‚¬í•­</a>
            <a href="/music/list">ë…¸ë˜</a>
            <a href="/news/list">ì‹œì‚¬ë‰´ìŠ¤</a>
        </div>

        <!-- ìš°ì¸¡ : ë¡œê·¸ì¸ or ë“œë¡­ë‹¤ìš´ -->
        <div class="navbar-right">

            <div class="navbar-right-inner">

                <!-- ë¹„íšŒì› -->
                <div sec:authorize="isAnonymous()" class="navbar-auth">
                    <a href="/login" class="login-button">ë¡œê·¸ì¸</a>
                </div>

                <!-- íšŒì› -->
                <div sec:authorize="isAuthenticated()" class="navbar-auth">

                    <div class="notify-wrap">
                        <button type="button"
                                class="btn btn-ghost btn-sm notify-toggle"
                                aria-label="ì•Œë¦¼">
                            ğŸ””
                            <span class="notify-badge">
                                0
                            </span>
                        </button>

                        <div class="notify-menu">
                            <div class="notify-menu-header">
                                <strong>ì•Œë¦¼</strong>
                                <button type="button" class="btn btn-ghost btn-sm notify-refresh">ìƒˆë¡œê³ ì¹¨</button>
                            </div>

                            <div class="notify-list">
                                <div class="notify-loading-text">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                            </div>

                            <div class="notify-pager">
                                <button type="button"
                                        class="btn btn-ghost btn-sm notify-prev"
                                        aria-label="ì´ì „ í˜ì´ì§€"
                                        disabled>
                                    â—€
                                </button>

                                <span class="notify-page">
                                    1
                                </span>

                                <button type="button"
                                        class="btn btn-ghost btn-sm notify-next"
                                        aria-label="ë‹¤ìŒ í˜ì´ì§€"
                                        disabled>
                                    â–¶
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="dropdown">
                        <button class="dropdown-toggle" type="button">
                            <span class="navbar-username">
                                <span sec:authentication="principal.displayName"></span>
                            </span>
                            <span class="navbar-greeting">ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤</span>
                            <span class="navbar-caret">â–¼</span>
                        </button>
                        <div class="dropdown-menu">
                            <a href="/my-page"
                               class="btn btn-ghost btn-full btn-sm dropdown-item">
                                ë§ˆì´í˜ì´ì§€
                            </a>

                            <a href="/admin/members"
                               class="btn btn-ghost btn-full btn-sm dropdown-item"
                               sec:authorize="hasRole('ADMIN')">
                                ê´€ë¦¬ìí˜ì´ì§€
                            </a>

                            <!-- POST ë°©ì‹ ë¡œê·¸ì•„ì›ƒ -->
                            <form id="logoutForm" action="/logout" method="post" style="display:none;">
                                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            </form>
                            <a href="#"
                               class="btn btn-ghost btn-full btn-sm dropdown-item dropdown-logout-link">
                                ë¡œê·¸ì•„ì›ƒ
                            </a>
                        </div>
                    </div>

                </div>

                <!-- ëª¨ë°”ì¼ í–„ë²„ê±° ë²„íŠ¼ -->
                <button type="button"
                        class="navbar-hamburger"
                        aria-label="ë©”ë‰´"
                        aria-expanded="false">
                    â˜°
                </button>

            </div>

            <!-- ëª¨ë°”ì¼ ë©”ë‰´ ì˜¤ë²„ë ˆì´/íŒ¨ë„ -->
            <div class="navbar-mobile-overlay" style="display:none;"></div>

            <nav class="navbar-mobile-menu" style="display:none;" aria-label="ëª¨ë°”ì¼ ë©”ë‰´">
                <div class="navbar-mobile-header">
                    <strong>ë©”ë‰´</strong>
                    <button type="button" class="navbar-mobile-close" aria-label="ë‹«ê¸°">âœ•</button>
                </div>

                <a href="/notice/list" class="navbar-mobile-link">ê³µì§€ì‚¬í•­</a>
                <a href="/music/list" class="navbar-mobile-link">ë…¸ë˜</a>
                <a href="/news/list" class="navbar-mobile-link">ì‹œì‚¬ë‰´ìŠ¤</a>

                <div class="navbar-mobile-sep"></div>

                <div sec:authorize="isAnonymous()">
                    <a href="/login" class="navbar-mobile-link">ë¡œê·¸ì¸</a>
                </div>

                <div sec:authorize="isAuthenticated()">
                    <a href="/my-page" class="navbar-mobile-link">ë§ˆì´í˜ì´ì§€</a>

                    <a href="/admin/members"
                       class="navbar-mobile-link"
                       sec:authorize="hasRole('ADMIN')">
                        ê´€ë¦¬ìí˜ì´ì§€
                    </a>

                    <a href="#"
                       class="navbar-mobile-link mobile-logout-link">
                        ë¡œê·¸ì•„ì›ƒ
                    </a>
                </div>
            </nav>

        </div>
    </div>

</th:block>


<th:block th:fragment="script">
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // ë“œë¡­ë‹¤ìš´ ë©”ë‰´
            const toggle = document.querySelector(".dropdown-toggle");
            const dropdown = document.querySelector(".dropdown");

            if (toggle && dropdown) {
                toggle.addEventListener("click", () => {
                    dropdown.classList.toggle("open");
                });

                document.addEventListener("click", (e) => {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove("open");
                    }
                });
            }

            // ë¡œê·¸ì•„ì›ƒ í† ìŠ¤íŠ¸ ì €ì¥
            function storeLogoutToast() {
                try {
                    sessionStorage.setItem("APP_TOAST", JSON.stringify({
                        message: "ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.",
                        options: {
                            variant: "info",
                            duration: 2000
                        }
                    }));
                } catch (e) {
                }
            }

            // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜
            function handleLogout() {
                const logoutForm = document.getElementById("logoutForm");
                const path = window.location.pathname || "";
                const writingPattern = /(notice|music|news)\/(write|edit)/;
                const isWritingPage = writingPattern.test(path);

                function goNext() {
                    if (isWritingPage) {
                        window.location.href = "/";
                    } else {
                        window.location.reload();
                    }
                }

                if (window.fetch) {
                    const headers = {
                        "X-Requested-With": "XMLHttpRequest"
                    };

                    if (window.CsrfUtil) {
                        CsrfUtil.apply(headers);
                    }

                    fetch("/logout", {
                        method: "POST",
                        headers: headers,
                        credentials: "same-origin"
                    }).then(function () {
                        storeLogoutToast();
                        goNext();
                    }).catch(function () {
                        storeLogoutToast();
                        if (logoutForm) {
                            logoutForm.submit();
                        } else {
                            goNext();
                        }
                    });
                } else if (logoutForm) {
                    storeLogoutToast();
                    logoutForm.submit();
                }
            }

            // ë¡œê·¸ì•„ì›ƒ í™•ì¸
            const logoutForm = document.getElementById("logoutForm");
            const logoutLinks = document.querySelectorAll(".dropdown-logout-link, .mobile-logout-link");

            if (logoutLinks.length > 0 && logoutForm) {
                logoutLinks.forEach(function (logoutLink) {
                    logoutLink.addEventListener("click", function (e) {
                        e.preventDefault();

                        if (window.AppModal && AppModal.confirm) {
                            AppModal.confirm(
                                "ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                                function () {
                                    handleLogout();
                                },
                                null,
                                { variant: "warning" }
                            );
                        } else {
                            if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                                handleLogout();
                            }
                        }
                    });
                });
            }

            // ëª¨ë°”ì¼ í–„ë²„ê±° ë©”ë‰´
            const burger = document.querySelector(".navbar-hamburger");
            const overlay = document.querySelector(".navbar-mobile-overlay");
            const menu = document.querySelector(".navbar-mobile-menu");
            const closeBtn = document.querySelector(".navbar-mobile-close");

            function openMobileMenu() {
                if (!burger || !overlay || !menu) return;

                overlay.style.display = "block";
                menu.style.display = "block";
                burger.setAttribute("aria-expanded", "true");
                document.body.classList.add("nav-mobile-open");
            }

            function closeMobileMenu() {
                if (!burger || !overlay || !menu) return;

                overlay.style.display = "none";
                menu.style.display = "none";
                burger.setAttribute("aria-expanded", "false");
                document.body.classList.remove("nav-mobile-open");
            }

            if (burger && overlay && menu) {
                burger.addEventListener("click", function () {
                    const isOpen = burger.getAttribute("aria-expanded") === "true";
                    if (isOpen) {
                        closeMobileMenu();
                    } else {
                        openMobileMenu();
                    }
                });

                overlay.addEventListener("click", function () {
                    closeMobileMenu();
                });

                if (closeBtn) {
                    closeBtn.addEventListener("click", function () {
                        closeMobileMenu();
                    });
                }

                menu.addEventListener("click", function (e) {
                    const target = e.target;
                    if (target && target.tagName === "A") {
                        closeMobileMenu();
                    }
                });

                document.addEventListener("keydown", function (e) {
                    if (e.key === "Escape") {
                        closeMobileMenu();
                    }
                });
            }

        });
    </script>
</th:block>
