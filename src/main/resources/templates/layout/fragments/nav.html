<!-- layout/fragments/nav.html -->
<th:block th:fragment="navbar">

    <div class="navbar"
         xmlns:th="http://www.thymeleaf.org"
         xmlns:sec="https://www.thymeleaf.org/extras/spring-security">

        <!-- 좌측 : 로고 -->
        <div class="navbar-left">
            <a href="/" class="logo">Community</a>
        </div>

        <!-- 중앙 메뉴 -->
        <div class="navbar-center">
            <a href="/notice/list">공지사항</a>
            <a href="/music/list">노래</a>
            <a href="/news/list">시사뉴스</a>
        </div>

        <!-- 우측 : 로그인 or 드롭다운 -->
        <div class="navbar-right">

            <!-- 비회원 -->
            <div sec:authorize="isAnonymous()">
                <a href="/login" class="login-button">로그인</a>
            </div>

            <!-- 회원 -->
            <div class="dropdown" sec:authorize="isAuthenticated()">
                <button class="dropdown-toggle" type="button">
                    <span class="navbar-username">
                        <span sec:authentication="principal.displayName"></span>
                    </span>님 반갑습니다▼
                </button>
                <div class="dropdown-menu">
                    <a href="/my-page"
                       class="btn btn-ghost btn-full btn-sm dropdown-item">
                        마이페이지
                    </a>

                    <!-- POST 방식 로그아웃 -->
                    <form id="logoutForm" action="/logout" method="post" style="display:none;">
                    </form>
                    <a href="#"
                       class="btn btn-ghost btn-full btn-sm dropdown-item dropdown-logout-link">
                        로그아웃
                    </a>
                </div>
            </div>

        </div>
    </div>

</th:block>


<th:block th:fragment="script">
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // 드롭다운 메뉴
            const toggle = document.querySelector(".dropdown-toggle");
            const dropdown = document.querySelector(".dropdown");

            if (toggle && dropdown) {
                toggle.addEventListener("click", () => {
                    dropdown.classList.toggle("open");
                });

                document.addEventListener("click", (e) => {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove("open");
                    }
                });
            }

            // 로그아웃 처리 공통 함수
            function handleLogout() {
                const logoutForm = document.getElementById("logoutForm");
                const path = window.location.pathname || "";
                const writingPattern = /(notice|music|news)\/(write|edit)/;
                const isWritingPage = writingPattern.test(path);

                function goNext() {
                    if (isWritingPage) {
                        window.location.href = "/";
                    } else {
                        window.location.reload();
                    }
                }

                if (window.fetch) {
                    fetch("/logout", {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    }).then(function () {
                    }).catch(function () {
                        if (logoutForm) {
                            logoutForm.submit();
                        }
                    }).finally(function () {
                        if (window.showAppToast) {
                            showAppToast("로그아웃 되었습니다.", {
                                variant: "info",
                                duration: 2000
                            });
                            setTimeout(goNext, 2000);
                        } else {
                            goNext();
                        }
                    });
                } else if (logoutForm) {
                    logoutForm.submit();
                }
            }

            // 로그아웃 확인
            const logoutLink = document.querySelector(".dropdown-logout-link");
            const logoutForm = document.getElementById("logoutForm");

            if (logoutLink && logoutForm) {
                logoutLink.addEventListener("click", function (e) {
                    e.preventDefault();

                    if (window.AppModal && AppModal.confirm) {
                        AppModal.confirm(
                            "로그아웃 하시겠습니까?",
                            function () {
                                handleLogout();
                            },
                            null,
                            { variant: "warning" }
                        );
                    } else {
                        if (confirm("로그아웃 하시겠습니까?")) {
                            handleLogout();
                        }
                    }
                });
            }
        });
    </script>
</th:block>
