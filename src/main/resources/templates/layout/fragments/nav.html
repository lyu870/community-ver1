<!-- layout/fragments/nav.html -->
<th:block th:fragment="navbar">

    <div class="navbar"
         xmlns:th="http://www.thymeleaf.org"
         xmlns:sec="https://www.thymeleaf.org/extras/spring-security">

        <!-- ì¢Œì¸¡ : ë¡œê³  -->
        <div class="navbar-left">
            <a href="/" class="logo">Community</a>
        </div>

        <!-- ì¤‘ì•™ ë©”ë‰´ -->
        <div class="navbar-center">
            <a href="/notice/list">ê³µì§€ì‚¬í•­</a>
            <a href="/music/list">ë…¸ë˜</a>
            <a href="/news/list">ì‹œì‚¬ë‰´ìŠ¤</a>
        </div>

        <!-- ìš°ì¸¡ : ë¡œê·¸ì¸ or ë“œë¡­ë‹¤ìš´ -->
        <div class="navbar-right">

            <!-- ë¹„íšŒì› -->
            <div sec:authorize="isAnonymous()">
                <a href="/login" class="login-button">ë¡œê·¸ì¸</a>
            </div>

            <!-- íšŒì› -->
            <div sec:authorize="isAuthenticated()" style="display:flex; align-items:center; gap:10px;">

                <div class="notify-wrap" style="position:relative;">
                    <button type="button"
                            class="btn btn-ghost btn-sm notify-toggle"
                            aria-label="ì•Œë¦¼"
                            style="position:relative;">
                        ğŸ””
                        <span class="notify-badge"
                              style="display:none; position:absolute; top:-4px; right:-4px; min-width:18px; height:18px; line-height:18px; border-radius:9px; font-size:12px; text-align:center; background:#e74c3c; color:#fff; padding:0 5px;">
                            0
                        </span>
                    </button>

                    <div class="notify-menu"
                         style="display:none; position:absolute; right:0; margin-top:8px; width:320px; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); padding:10px; z-index:999;">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                            <strong>ì•Œë¦¼</strong>
                            <button type="button" class="btn btn-ghost btn-sm notify-refresh">ìƒˆë¡œê³ ì¹¨</button>
                        </div>

                        <div class="notify-list">
                            <div style="color:#666; font-size:0.95rem;">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>

                        <div class="notify-pager"
                             style="margin-top:8px; padding-top:8px; border-top:1px solid #eee; display:flex; align-items:center; justify-content:center; gap:12px;">
                            <button type="button"
                                    class="btn btn-ghost btn-sm notify-prev"
                                    aria-label="ì´ì „ í˜ì´ì§€"
                                    disabled>
                                â—€
                            </button>

                            <span class="notify-page"
                                  style="font-size:0.9rem; color:#666;">
                                1
                            </span>

                            <button type="button"
                                    class="btn btn-ghost btn-sm notify-next"
                                    aria-label="ë‹¤ìŒ í˜ì´ì§€"
                                    disabled>
                                â–¶
                            </button>
                        </div>
                    </div>
                </div>

                <div class="dropdown">
                    <button class="dropdown-toggle" type="button">
                        <span class="navbar-username">
                            <span sec:authentication="principal.displayName"></span>
                        </span>ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤â–¼
                    </button>
                    <div class="dropdown-menu">
                        <a href="/my-page"
                           class="btn btn-ghost btn-full btn-sm dropdown-item">
                            ë§ˆì´í˜ì´ì§€
                        </a>

                        <a href="/admin/members"
                           class="btn btn-ghost btn-full btn-sm dropdown-item"
                           sec:authorize="hasRole('ADMIN')">
                            ê´€ë¦¬ìí˜ì´ì§€
                        </a>

                        <!-- POST ë°©ì‹ ë¡œê·¸ì•„ì›ƒ -->
                        <form id="logoutForm" action="/logout" method="post" style="display:none;">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        </form>
                        <a href="#"
                           class="btn btn-ghost btn-full btn-sm dropdown-item dropdown-logout-link">
                            ë¡œê·¸ì•„ì›ƒ
                        </a>
                    </div>
                </div>

            </div>

        </div>
    </div>

</th:block>


<th:block th:fragment="script">
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // ë“œë¡­ë‹¤ìš´ ë©”ë‰´
            const toggle = document.querySelector(".dropdown-toggle");
            const dropdown = document.querySelector(".dropdown");

            if (toggle && dropdown) {
                toggle.addEventListener("click", () => {
                    dropdown.classList.toggle("open");
                });

                document.addEventListener("click", (e) => {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove("open");
                    }
                });
            }

            // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜
            function handleLogout() {
                const logoutForm = document.getElementById("logoutForm");
                const path = window.location.pathname || "";
                const writingPattern = /(notice|music|news)\/(write|edit)/;
                const isWritingPage = writingPattern.test(path);

                function goNext() {
                    if (isWritingPage) {
                        window.location.href = "/";
                    } else {
                        window.location.reload();
                    }
                }

                if (window.fetch) {
                    const headers = {
                        "X-Requested-With": "XMLHttpRequest"
                    };

                    if (window.CsrfUtil) {
                        CsrfUtil.apply(headers);
                    }

                    fetch("/logout", {
                        method: "POST",
                        headers: headers
                    }).then(function () {
                    }).catch(function () {
                        if (logoutForm) {
                            logoutForm.submit();
                        }
                    }).finally(function () {
                        if (window.showAppToast) {
                            showAppToast("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.", {
                                variant: "info",
                                duration: 2000
                            });
                            setTimeout(goNext, 2000);
                        } else {
                            goNext();
                        }
                    });
                } else if (logoutForm) {
                    logoutForm.submit();
                }
            }

            // ë¡œê·¸ì•„ì›ƒ í™•ì¸
            const logoutLink = document.querySelector(".dropdown-logout-link");
            const logoutForm = document.getElementById("logoutForm");

            if (logoutLink && logoutForm) {
                logoutLink.addEventListener("click", function (e) {
                    e.preventDefault();

                    if (window.AppModal && AppModal.confirm) {
                        AppModal.confirm(
                            "ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                            function () {
                                handleLogout();
                            },
                            null,
                            { variant: "warning" }
                        );
                    } else {
                        if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                            handleLogout();
                        }
                    }
                });
            }
        });
    </script>
</th:block>
